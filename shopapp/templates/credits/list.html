{% extends 'layout.html' %}
{% block title %}Credits & Reminders{% endblock %}
{% block crumb %}Credits{% endblock %}

{% block content %}
<div class="bo-card mb-4">
  <h1 class="h4 mb-2">Outstanding credits</h1>
  <p class="bo-soft mb-0">Customers with unpaid or adjusted udhar. Configure auto reminders via environment variables.</p>
</div>

<div class="bo-card">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="h5 mb-0">Ledger</h2>
    <span class="badge bo-badge">{{ credits|length }} open</span>
  </div>
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle mb-0 bo-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Customer</th>
          <th>Item</th>
          <th>Amount</th>
          <th>Phone</th>
          <th>Reminders</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for credit in credits %}
        <tr>
          <td>{{ credit.date.strftime('%Y-%m-%d') }}</td>
          <td>{{ credit.customer_name }}</td>
          <td>{{ credit.item }}</td>
          <td>Rs {{ '%.2f'|format(credit.total) }}</td>
          <td>{{ credit.reminder_phone or credit.customer.phone if credit.customer else '-' }}</td>
          <td>
            {% if credit.last_reminder_at %}
            <span class="bo-soft small">Last: {{ credit.last_reminder_at.strftime('%Y-%m-%d %H:%M') }}</span><br>
            <span class="badge bo-badge-light">Total {{ credit.reminder_count or 0 }}</span>
            {% else %}
            <span class="bo-soft small">No reminders yet</span>
            {% endif %}
          </td>
          <td>
            {% if credit.reminder_opt_out %}
            <span class="badge bo-badge-danger">Opted out</span>
            {% else %}
            <span class="badge bo-badge">Active</span>
            {% endif %}
          </td>
          <td class="d-flex flex-wrap gap-2">
            <form method="POST" action="{{ url_for('credits.send_single_reminder', credit_id=credit.id) }}">
              <button class="btn btn-sm bo-btn-outline" type="submit" {% if credit.reminder_opt_out %}disabled{% endif %}>
                Send now
              </button>
            </form>
            <form method="POST" action="{{ url_for('credits.toggle_opt_out', credit_id=credit.id) }}">
              <button class="btn btn-sm {% if credit.reminder_opt_out %}bo-btn{% else %}btn-danger{% endif %}" type="submit">
                {% if credit.reminder_opt_out %}Enable{% else %}Disable{% endif %}
              </button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="8" class="bo-soft">No outstanding credits. Great job!</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
