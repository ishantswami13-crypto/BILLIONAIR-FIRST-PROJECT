{% extends 'layout.html' %}
{% block content %}
<div class="bo-card mb-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-1">Record expense</h1>
      <p class="bo-soft mb-0">Tag spend against categories. Keywords auto-suggest based on rules.</p>
    </div>
    <a class="btn btn-sm bo-btn-outline" href="{{ url_for('expenses.categories') }}">Manage categories</a>
  </div>
  <form class="row g-3" method="POST">
    <div class="col-md-2">
      <label class="form-label">Date</label>
      <input class="form-control bo-input" type="date" name="date" value="{{ request.form.get('date', '') }}">
    </div>
    <div class="col-md-4">
      <label class="form-label">Category</label>
      <select class="form-select bo-input" name="category_id">
        <option value="">Auto / choose...</option>
        {% for cat in categories %}
        <option value="{{ cat.id }}">{{ cat.name }}</option>
        {% endfor %}
      </select>
      <small class="bo-soft">Need a one-off label? Type it below.</small>
      <input class="form-control bo-input mt-2" type="text" name="category" placeholder="Optional custom category">
    </div>
    <div class="col-md-3">
      <label class="form-label">Amount</label>
      <input class="form-control bo-input" type="number" step="0.01" name="amount" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Notes</label>
      <textarea class="form-control bo-input" name="notes" rows="1" placeholder="Supplier, reference, etc."></textarea>
    </div>
    <div class="col-12 text-end">
      <button class="btn bo-btn" type="submit">Save expense</button>
    </div>
  </form>
</div>

<div class="bo-card">
  <h2 class="h5 mb-3">Recent expenses</h2>
  <form method="POST" action="{{ url_for('expenses.bulk_reassign') }}">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
      <div class="form-check me-3">
        <input class="form-check-input" type="checkbox" id="selectAllExpenses">
        <label class="form-check-label small text-uppercase" for="selectAllExpenses">Select all</label>
      </div>
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <select class="form-select form-select-sm" name="bulk_category_id">
          <option value="">- choose category -</option>
          {% for cat in categories %}
          <option value="{{ cat.id }}">{{ cat.name }}</option>
          {% endfor %}
        </select>
        <span class="bo-soft small">or</span>
        <input class="form-control form-control-sm" type="text" name="bulk_category" placeholder="Custom label">
        <button class="btn btn-sm bo-btn-outline" type="submit">Reassign selected</button>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-dark table-hover align-middle mb-0 bo-table">
        <thead>
          <tr class="small text-uppercase">
            <th style="width:38px;"></th>
            <th>Date</th>
            <th>Category</th>
            <th>Amount</th>
            <th>Notes</th>
            <th>Smart suggestion</th>
          </tr>
        </thead>
        <tbody>
          {% for e in expenses %}
          {% set badge_color = e.category_rel.color if e.category_rel else '#62b5ff' %}
          <tr>
            <td>
              <input class="form-check-input" type="checkbox" name="expense_ids" value="{{ e.id }}" data-expense-checkbox>
            </td>
            <td>{{ e.date }}</td>
            <td>
              <span class="badge" style="background-color: {{ badge_color }}; color: #0e1629;">
                {{ e.category or 'Uncategorised' }}
              </span>
            </td>
            <td>Rs {{ '%.2f'|format(e.amount) }}</td>
            <td>{{ e.notes or '—' }}</td>
            <td>
              {% set suggestion = suggestions.get(e.id) %}
              {% if suggestion %}
              <div class="d-flex flex-wrap align-items-center gap-2">
                <span class="badge bg-warning text-dark">AI hint: {{ suggestion.name }}</span>
                <form method="POST" action="{{ url_for('expenses.apply_suggestion', expense_id=e.id) }}">
                  <button class="btn btn-sm bo-btn-outline" type="submit">Apply</button>
                </form>
              </div>
              {% else %}
              <span class="bo-soft small">—</span>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="bo-soft text-center">No expenses recorded yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  (function () {
    const toggle = document.getElementById('selectAllExpenses');
    if (!toggle) { return; }
    const boxes = () => document.querySelectorAll('[data-expense-checkbox]');
    toggle.addEventListener('change', () => {
      boxes().forEach((box) => { box.checked = toggle.checked; });
    });
  })();
</script>
{% endblock %}