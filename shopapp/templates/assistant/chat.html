{% extends "layout.html" %}
{% block title %}Assistant{% endblock %}

{% block head %}
<style>
  .assistant-shell {
    display: flex;
    flex-direction: column;
    gap: 18px;
  }
  .assistant-chat {
    max-height: 420px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }
  .assistant-message {
    border-radius: 16px;
    padding: 0.9rem 1rem;
    background: var(--glass);
    border: 1px solid var(--line);
  }
  .assistant-message.user {
    background: rgba(0, 212, 179, 0.18);
    border-color: rgba(0, 212, 179, 0.35);
  }
  .assistant-suggestions button {
    border-radius: 999px;
    padding: 0.35rem 0.8rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="assistant-shell">
  <div class="card">
    <h2 class="mb-1">AI Ops Assistant</h2>
    <div class="text-muted">Ask about sales, expenses, credits or inventory. Responses use the last 90 days of data.</div>
    <div class="assistant-suggestions d-flex flex-wrap gap-2 mt-3">
      <button type="button" class="btn-ghost btn-sm" data-suggest="Show me today's revenue vs expenses">Today’s trend</button>
      <button type="button" class="btn-ghost btn-sm" data-suggest="Which items are low on stock?">Low stock</button>
      <button type="button" class="btn-ghost btn-sm" data-suggest="How much unpaid credit do we have this week?">Credit status</button>
    </div>
  </div>

  <div class="card">
    <div class="assistant-chat" id="chatLog">
      {% for message in messages %}
        <div class="assistant-message {{ 'user' if message.role == 'user' else 'bot' }}">
          <small class="text-muted text-uppercase d-block mb-1">{{ message.role }}</small>
          <div>{{ message.content|replace('\n', '<br>')|safe }}</div>
        </div>
      {% endfor %}
    </div>

    <form id="chatForm" class="row g-2 align-items-end mt-3">
      <input type="hidden" name="session_id" value="{{ chat_session.id }}">
      <div class="col-md-9">
        <label class="form-label small text-uppercase">Message</label>
        <input class="form-control" type="text" name="message" autocomplete="off" placeholder="Ask a question about your store" required>
      </div>
      <div class="col-md-3 d-flex gap-2">
        <button class="btn-primary w-100" type="submit">Send</button>
        <a class="btn-ghost" href="{{ url_for('assistant.export_session', session_id=chat_session.id) }}">Export</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  const chatLog = document.getElementById('chatLog');
  const chatForm = document.getElementById('chatForm');
  const suggestionButtons = document.querySelectorAll('[data-suggest]');

  const renderMessage = (role, content) => {
    const wrapper = document.createElement('div');
    wrapper.className = `assistant-message ${role === 'user' ? 'user' : 'bot'}`;
    const title = document.createElement('small');
    title.className = 'text-muted text-uppercase d-block mb-1';
    title.textContent = role;
    wrapper.appendChild(title);

    const body = document.createElement('div');
    body.innerHTML = content.replace(/\n/g, '<br>');
    wrapper.appendChild(body);

    chatLog.appendChild(wrapper);
    chatLog.scrollTop = chatLog.scrollHeight;
  };

  chatForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const formData = new FormData(chatForm);
    const messageInput = chatForm.querySelector('[name="message"]');
    const message = messageInput.value.trim();
    if (!message) {
      return;
    }
    renderMessage('user', message);
    messageInput.value = '';

    const payload = {
      session_id: formData.get('session_id'),
      message,
    };

    try {
      const response = await fetch('{{ url_for("assistant.api_message") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!response.ok) {
        throw new Error('Request failed');
      }
      const data = await response.json();
      (data.messages || []).forEach(msg => renderMessage(msg.role, msg.content));
    } catch (error) {
      renderMessage('assistant', 'I could not process that request right now. Please try again in a moment.');
    }
  });

  suggestionButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const suggestion = button.getAttribute('data-suggest');
      const input = chatForm.querySelector('[name="message"]');
      input.value = suggestion;
      input.focus();
    });
  });
</script>
{% endblock %}
