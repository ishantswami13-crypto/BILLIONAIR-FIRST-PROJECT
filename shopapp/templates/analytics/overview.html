{% extends "layout.html" %}
{% block title %}Analytics{% endblock %}
{% block content %}
<section class="card fadeUp">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div>
      <h1 style="font-size:var(--f-xl);font-weight:700;">Analytics</h1>
      <p style="color:var(--ink-60)">Revenue, expenses, and profit trends.</p>
    </div>
    <form method="get" class="segment">
      <button name="range" value="30" class="{% if range==30 %}active{% endif %}">30d</button>
      <button name="range" value="90" class="{% if range==90 %}active{% endif %}">90d</button>
      <button name="range" value="180" class="{% if range==180 %}active{% endif %}">180d</button>
      <a class="btn" href="/analytics/export?range={{ range }}">Export CSV</a>
    </form>
  </div>
</section>

<section class="card fadeUp" style="animation-delay:.08s">
  <canvas id="revExp" height="160"></canvas>
</section>

<section class="card fadeUp" style="animation-delay:.12s">
  <h3 style="font-size:var(--f-lg);font-weight:600;margin-bottom:8px;">Top Customers (LTV)</h3>
  <table class="table">
    <thead><tr><th>Name</th><th>Orders</th><th>Total</th><th>Last purchase</th></tr></thead>
    <tbody>
      {% for r in ltv %}
      <tr><td>{{ r.customer }}</td><td>{{ r.orders }}</td><td>₹{{ '%.2f'|format(r.total) }}</td><td>{{ r.last_purchase or '—' }}</td></tr>
      {% else %}
      <tr><td colspan="4" style="color:var(--ink-60)">No data yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
const a={{ (series or {}) | tojson }};
if(a.daily){
  new Chart(document.getElementById('revExp'),{
    type:'line',
    data:{
      labels:a.daily.map(x=>x.label),
      datasets:[
        {label:'Revenue', data:a.daily.map(x=>x.revenue), borderColor:'#82FFC3', backgroundColor:'rgba(130,255,195,.16)', tension:.35, fill:true},
        {label:'Expenses', data:a.daily.map(x=>x.expenses), borderColor:'rgba(255,211,110,1)', backgroundColor:'rgba(255,211,110,.12)', tension:.35, fill:true},
        {label:'Profit', data:a.daily.map(x=>x.profit), borderColor:'rgba(124,242,156,1)', backgroundColor:'rgba(124,242,156,.10)', tension:.35, fill:true}
      ]
    },
    options:{plugins:{legend:{labels:{color:'#fff'}}},
      scales:{x:{ticks:{color:'rgba(255,255,255,.7)'},grid:{color:'rgba(255,255,255,.08)'}},
              y:{ticks:{color:'rgba(255,255,255,.7)'},grid:{color:'rgba(255,255,255,.08)'}}}}
  });
}
</script>
{% endblock %}
