{% extends "layout.html" %}{% block title %}Analytics Â· ShopApp{% endblock %}
{% block content %}
<div class="confettiBar" aria-hidden="true"></div>
<section class="card" style="margin-top:18px">
  <div class="sectionTitle"><div class="spark"></div><h1><span class="gradientAnim">Analytics.</span> Clear trends, smart moves.</h1></div>
  <div style="display:flex;justify-content:space-between;align-items:end;gap:12px;flex-wrap:wrap;margin-top:8px;">
    <p class="subtle">Revenue vs expenses, profit, and top customers â€” no clutter.</p>
    <div class="pillTabs">{% set w=days or 30 %}
      <a href="?days=30" class="{% if w==30 %}active{% endif %}">30d</a>
      <a href="?days=90" class="{% if w==90 %}active{% endif %}">90d</a>
      <a href="?days=180" class="{% if w==180 %}active{% endif %}">180d</a>
      <a class="btn link" href="{{ url_for('reports.analytics_export', days=w) }}">Export CSV</a>
    </div>
  </div>
</section>

<section class="grid-4">
  <div class="card sumCard"><div class="chip">ðŸ’°</div><div><div class="label">Revenue</div><div class="value" data-count="{{ analytics.summary.total_revenue or 0 }}">â‚¹0</div></div></div>
  <div class="card sumCard"><div class="chip">ðŸ§¾</div><div><div class="label">Expenses</div><div class="value" data-count="{{ analytics.summary.total_expenses or 0 }}">â‚¹0</div></div></div>
  <div class="card sumCard"><div class="chip">ðŸ“ˆ</div><div><div class="label">Profit</div><div class="value" data-count="{{ analytics.summary.total_profit or 0 }}">â‚¹0</div></div></div>
  <div class="card sumCard"><div class="chip">âš¡</div><div><div class="label">Avg daily profit</div><div class="value" data-count="{{ analytics.summary.average_daily_profit or 0 }}">â‚¹0</div></div></div>
</section>

<section class="card doodle"><h3 style="margin-bottom:8px;">Revenue vs expenses</h3><canvas id="revExp" height="180"></canvas></section>

<section class="grid-2-1">
  <div class="card"><h3>Top customers</h3>
    <table class="table" style="margin-top:8px;"><thead><tr><th>Name</th><th>Orders</th><th>Total</th><th>Last purchase</th></tr></thead>
      <tbody>{% for row in analytics.ltv %}<tr><td>{{ row.customer }}</td><td>{{ row.orders }}</td><td>â‚¹{{ '%.0f'|format(row.total) }}</td><td>{{ row.last_purchase or 'â€”' }}</td></tr>
      {% else %}<tr><td colspan="4" class="subtle">No data yet.</td></tr>{% endfor %}</tbody></table>
  </div>
  <div class="card"><h3>Notes</h3>
    <ul style="margin-top:8px;display:grid;gap:6px;">
      <li>Best-selling: <b>{{ analytics.best_item.item if analytics.best_item else 'â€”' }}</b></li>
      <li>Low stock ready to reorder: <b>{{ analytics.low_stock|length if analytics.low_stock else 0 }}</b></li>
      <li>Try: mini WhatsApp promo to top customers.</li>
    </ul>
  </div>
</section>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
  document.querySelectorAll('.value[data-count]').forEach(el=>ShopFX.countUp(el,{money:true}));
  const A={{ analytics or {} | tojson }}, ctx=document.getElementById('revExp');
  if(ctx&&A.daily){new Chart(ctx,{type:'line',data:{labels:A.daily.map(r=>r.label),datasets:[
    {label:'Revenue',data:A.daily.map(r=>r.revenue),borderColor:'#7d00ff',backgroundColor:'rgba(125,0,255,.10)',tension:.35,fill:true},
    {label:'Expenses',data:A.daily.map(r=>r.expenses),borderColor:'#ff007a',backgroundColor:'rgba(255,0,122,.08)',tension:.35,fill:true},
    {label:'Profit',data:A.daily.map(r=>r.profit),borderColor:'#00c2a8',backgroundColor:'rgba(0,194,168,.10)',tension:.35,fill:true}]},
    options:{plugins:{legend:{labels:{color:'#1d1d1f'}}},scales:{x:{grid:{color:'#eee'}},y:{grid:{color:'#eee'}}}}});}
</script>
{% endblock %}
