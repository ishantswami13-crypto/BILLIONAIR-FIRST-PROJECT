{% extends "layout.html" %}
{% block title %}Access Control &middot; ShopApp Cloud{% endblock %}
{% block crumb %}Access Control{% endblock %}
{% block content %}
<div class="d-flex gap-2 mb-4">
  <a class="btn btn-sm {% if request.path.endswith('/branding') %}btn-primary{% else %}btn-outline-primary{% endif %}" href="{{ url_for('settings.branding') }}">Branding</a>
  <a class="btn btn-sm {% if request.path.endswith('/access') %}btn-primary{% else %}btn-outline-primary{% endif %}" href="{{ url_for('settings.access_dashboard') }}">Access</a>
  <a class="btn btn-sm {% if request.path.endswith('/connect') %}btn-primary{% else %}btn-outline-primary{% endif %}" href="{{ url_for('settings.connect_hub') }}">Connect</a>
</div>
<div class="row g-4">
  <div class="col-lg-6">
    <div class="bo-card h-100">
      <div class="bo-card__header">
        <div>
          <h2 class="bo-card__title mb-1">Team & Roles</h2>
          <p class="bo-soft small mb-0">Manage teammate roles across owner, cashier, and accountant profiles.</p>
        </div>
        <span class="badge bg-dark">Multi-device ready</span>
      </div>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr class="small text-uppercase text-muted">
              <th>User</th>
              <th>Email</th>
              <th>Role</th>
              <th>Last login</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
          {% for user in users %}
            <tr>
              <td>
                <div class="fw-semibold">{{ user.username }}</div>
                <div class="small text-muted">{{ user.phone or "—" }}</div>
              </td>
              <td>{{ user.email or "—" }}</td>
              <td>
                {% if user.username == session.get("user") %}
                  <span class="badge bg-secondary text-uppercase">{{ user.normalized_role }}</span>
                {% else %}
                  <form method="POST" action="{{ url_for('settings.update_role', user_id=user.id) }}" class="d-flex align-items-center gap-2">
                    <select class="form-select form-select-sm" name="role">
                      {% for role in roles %}
                        <option value="{{ role.value }}" {% if role.value == user.normalized_role %}selected{% endif %}>{{ role.value|capitalize }}</option>
                      {% endfor %}
                    </select>
                    <button class="btn btn-sm btn-outline-primary" type="submit">Save</button>
                  </form>
                {% endif %}
              </td>
              <td class="small">
                {% if user.last_login_at %}
                  {{ user.last_login_at.strftime('%d %b %Y %H:%M') }}
                {% else %}
                  Never
                {% endif %}
              </td>
              <td></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="bo-card h-100">
      <div class="bo-card__header">
        <div>
          <h2 class="bo-card__title mb-1">Invite Teammate</h2>
          <p class="bo-soft small mb-0">Generate a secure invite link that expires after 72 hours.</p>
        </div>
      </div>
      <form method="POST" action="{{ url_for('settings.create_invite') }}" class="row g-3">
        <div class="col-12">
          <label class="form-label small text-uppercase">Email</label>
          <input type="email" class="form-control" name="email" placeholder="cashier@shop.com" required>
        </div>
        <div class="col-12">
          <label class="form-label small text-uppercase">Role</label>
          <select class="form-select" name="role">
            {% for role in roles %}
              <option value="{{ role.value }}" {% if role.value == 'cashier' %}selected{% endif %}>{{ role.value|capitalize }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12">
          <button class="btn btn-primary w-100" type="submit">Create invite</button>
        </div>
      </form>
      <hr class="my-4">
      <div>
        <h3 class="h6 text-uppercase mb-3">Open invitations</h3>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr class="small text-uppercase text-muted">
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Expires</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
            {% for invite in invites %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ invite.email }}</div>
                  {% if invite.status in ('pending', 'sent') %}
                    {% set invite_url = url_for('auth.register', token=invite.token, _external=True) %}
                    <div class="small text-muted">Link: <code>{{ invite_url }}</code></div>
                  {% endif %}
                </td>
                <td>{{ invite.role.value|capitalize if invite.role else invite.role }}</td>
                <td>
                  <span class="badge bg-{{ 'success' if invite.status == 'accepted' else 'warning' if invite.status in ('pending','sent') else 'secondary' }}">{{ invite.status|capitalize }}</span>
                </td>
                <td class="small">
                  {% if invite.expires_at %}
                    {{ invite.expires_at.strftime('%d %b %Y %H:%M') }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td class="text-end">
                  <div class="d-flex gap-2 justify-content-end">
                    {% if invite.status in ('pending', 'sent') %}
                      <form method="POST" action="{{ url_for('settings.resend_invite', invite_id=invite.id) }}">
                        <button class="btn btn-sm btn-outline-secondary" type="submit">Resend</button>
                      </form>
                      <form method="POST" action="{{ url_for('settings.revoke_invite', invite_id=invite.id) }}">
                        <button class="btn btn-sm btn-outline-danger" type="submit">Revoke</button>
                      </form>
                    {% else %}
                      —
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="5" class="text-muted text-center py-4">No invitations yet.</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="bo-card mt-4">
  <div class="bo-card__header">
    <div>
      <h2 class="bo-card__title mb-1">Active Devices</h2>
      <p class="bo-soft small mb-0">Track and revoke active sessions across browsers and devices.</p>
    </div>
  </div>
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead>
        <tr class="small text-uppercase text-muted">
          <th>User</th>
          <th>Device</th>
          <th>IP</th>
          <th>Signed in</th>
          <th>Last seen</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
      {% for record in sessions %}
        <tr>
          <td>{{ record.user.username }}</td>
          <td class="small">{{ record.user_agent or "Unknown" }}</td>
          <td class="small">{{ record.ip_address or "—" }}</td>
          <td class="small">{{ record.created_at.strftime('%d %b %Y %H:%M') }}</td>
          <td class="small">{{ record.last_seen_at.strftime('%d %b %Y %H:%M') }}</td>
          <td class="text-end">
            <form method="POST" action="{{ url_for('settings.revoke_session', session_id=record.id) }}">
              <button class="btn btn-sm btn-outline-danger" type="submit">Sign out</button>
            </form>
          </td>
        </tr>
      {% else %}
        <tr>
          <td colspan="6" class="text-center text-muted py-4">No active sessions detected.</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="bo-card mt-4">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
    <div>
      <h2 class="bo-card__title mb-1">Privacy tools</h2>
      <p class="bo-soft small mb-0">Download everything you’ve done here anytime—quests, streaks, referrals.</p>
    </div>
    <a class="btn btn-outline-light" href="{{ url_for('settings.download_profile_data') }}">Download My Data</a>
  </div>
</div>
{% endblock %}
