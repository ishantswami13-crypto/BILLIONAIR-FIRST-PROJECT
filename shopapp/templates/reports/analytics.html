{% extends 'layout.html' %}
{% from 'components/macros.html' import card, stat %}
{% block title %}Analytics{% endblock %}
{% block crumb %}Reports / Analytics{% endblock %}

{% block head %}
<style>
  .heatmap-grid {
    display: grid;
    grid-template-columns: 80px repeat(24, 1fr);
    gap: 4px;
    font-size: 0.75rem;
  }
  .heatmap-cell {
    min-height: 28px;
    background: var(--bg, rgba(98, 181, 255, 0.1));
    color: #0e1629;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .heatmap-legend {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  .heatmap-legend span {
    width: 40px;
    height: 12px;
    border-radius: 4px;
    display: inline-block;
  }
</style>
{% endblock %}

{% block content %}
<div id="analytics-root" class="bo-stack" data-endpoint="{{ url_for('reports.analytics_data') }}" data-analytics='{{ analytics|tojson|safe }}'>
{% call card(classes='mb-4') %}
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
    <div>
      <h1 class="h4 mb-1">Business analytics</h1>
      <p class="bo-soft mb-0">Revenue, expenses, profit trend and customer insights.</p>
    </div>
    <div class="d-flex gap-2 align-items-center" data-print-hide>
      <label class="form-label mb-0" for="analyticsWindow">Window</label>
      <select class="form-select form-select-sm" id="analyticsWindow" data-analytics-window>
        {% for option in [30, 60, 90, 180, 365] %}
        <option value="{{ option }}" {% if days == option %}selected{% endif %}>Last {{ option }} days</option>
        {% endfor %}
      </select>
      <a class="btn btn-sm bo-btn-outline" href="{{ url_for('reports.analytics_export', days=days) }}">Export CSV</a>
      <button class="btn btn-sm bo-btn-outline" type="button" data-print-analytics>Print</button>
    </div>
    <div class="bo-soft small" data-print-only>
      Printed from ShopApp Cloud on <span data-print-stamp></span>
    </div>
  </div>
  <div class="row g-3 mt-2 bo-stats" id="analytics-summary">
    <div class="col-6 col-lg-3" data-summary="total_revenue" data-prefix="Rs " data-dp="2">
      {{ stat('Revenue', 'Rs ' ~ '%.2f'|format(analytics.summary.total_revenue), classes='h-100') }}
    </div>
    <div class="col-6 col-lg-3" data-summary="total_expenses" data-prefix="Rs " data-dp="2">
      {{ stat('Expenses', 'Rs ' ~ '%.2f'|format(analytics.summary.total_expenses), classes='h-100') }}
    </div>
    <div class="col-6 col-lg-3" data-summary="total_profit" data-prefix="Rs " data-dp="2">
      {{ stat('Profit', 'Rs ' ~ '%.2f'|format(analytics.summary.total_profit), classes='h-100 text-success') }}
    </div>
    <div class="col-6 col-lg-3" data-summary="average_daily_profit" data-prefix="Rs " data-dp="2">
      {{ stat('Avg daily profit', 'Rs ' ~ '%.2f'|format(analytics.summary.average_daily_profit), classes='h-100') }}
    </div>
  </div>
{% endcall %}

{% call card(header='Revenue vs expenses', subtitle='Track cashflow and profit across time.', classes='mb-4') %}
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
  </div>
  <ul class="nav nav-pills mb-3" id="analytics-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="daily-tab" data-bs-toggle="pill" data-bs-target="#daily-pane" type="button">Daily</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="weekly-tab" data-bs-toggle="pill" data-bs-target="#weekly-pane" type="button">Weekly</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="monthly-tab" data-bs-toggle="pill" data-bs-target="#monthly-pane" type="button">Monthly</button>
    </li>
  </ul>
  <div class="tab-content">
    <div class="tab-pane fade show active" id="daily-pane">
      <div class="bo-loading-surface" data-loading="false">
        <div class="bo-loading-placeholder">
          <div class="bo-shimmer bo-shimmer-block bo-shimmer-block--chart-sm"></div>
        </div>
        <div class="bo-loading-content">
          <canvas id="dailyChart" height="160"></canvas>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="weekly-pane">
      <div class="bo-loading-surface" data-loading="false">
        <div class="bo-loading-placeholder">
          <div class="bo-shimmer bo-shimmer-block bo-shimmer-block--chart-sm"></div>
        </div>
        <div class="bo-loading-content">
          <canvas id="weeklyChart" height="160"></canvas>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="monthly-pane">
      <div class="bo-loading-surface" data-loading="false">
        <div class="bo-loading-placeholder">
          <div class="bo-shimmer bo-shimmer-block bo-shimmer-block--chart-sm"></div>
        </div>
        <div class="bo-loading-content">
          <canvas id="monthlyChart" height="160"></canvas>
        </div>
      </div>
    </div>
  </div>
{% endcall %}

<div class="row g-4 mb-4">
  <div class="col-lg-7">
    <div class="bo-card h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 mb-0">Sales heatmap (last 30 days)</h2>
        <div class="heatmap-legend">
          <span style="background: rgba(98,181,255,0.08);"></span>
          <small class="bo-soft">Low</small>
          <span style="background: rgba(98,181,255,0.6);"></span>
          <small class="bo-soft">High</small>
        </div>
      </div>
      <div class="heatmap-grid" id="heatmapGrid"></div>
    </div>
  </div>
  <div class="col-lg-5">
    <div class="bo-card h-100">
      <h2 class="h5 mb-3">Top customers (LTV)</h2>
      <div class="table-responsive">
        <table class="table table-dark table-sm mb-0">
          <thead>
            <tr>
              <th>Name</th>
              <th>Orders</th>
              <th>Total</th>
              <th>Last purchase</th>
            </tr>
          </thead>
          <tbody id="ltvTable">
            {% for row in analytics.ltv %}
            <tr>
              <td>{{ row.customer }}</td>
              <td>{{ row.orders }}</td>
              <td>Rs {{ '%.2f'|format(row.total) }}</td>
              <td>{{ row.last_purchase or 'â€”' }}</td>
            </tr>
            {% else %}
            <tr>
              <td colspan="4" class="bo-soft">No customer data yet.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% call card(header='Expense categories', subtitle='Breakdown of spend by category across the selected window.', classes='mb-4') %}
  <div class="list-group list-group-flush" id="categoryList">
    {% for cat in analytics.categories %}
    <div class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
      <div class="d-flex align-items-center gap-2">
        <span class="badge" style="background-color: {{ cat.color }}; color: #0e1629;">{{ cat.name }}</span>
        <span class="bo-soft small">{{ cat.share }}% of spend</span>
      </div>
      <div class="flex-grow-1 w-100 w-md-auto">
        <div class="progress" style="height: 6px;">
          <div class="progress-bar" role="progressbar" style="width: {{ cat.share }}%; background-color: {{ cat.color }};"></div>
        </div>
      </div>
      <div class="fw-semibold">Rs {{ '%.2f'|format(cat.amount) }}</div>
    </div>
    {% else %}
    <div class="list-group-item bo-soft">No expenses recorded in this period.</div>
    {% endfor %}
  </div>
{% endcall %}

{% call card(header='Operational recommendations', subtitle='Heuristics based on inventory movement to keep shelves optimised.') %}
  <div class="list-group list-group-flush" id="recommendationsList">
    {% for rec in analytics.recommendations %}
    <div class="list-group-item">
      <div class="d-flex justify-content-between align-items-start gap-3">
        <div>
          {% set badge_class = 'bo-badge' %}
          {% if rec.type == 'reorder' %}
            {% set badge_class = 'bo-badge-warning' %}
          {% elif rec.type == 'slow' %}
            {% set badge_class = 'bo-badge-danger' %}
          {% elif rec.type == 'info' %}
            {% set badge_class = 'bo-badge-light' %}
          {% endif %}
          <span class="badge {{ badge_class }} text-uppercase small">
            {{ rec.type }}
          </span>
          <h3 class="h6 mt-2 mb-1">{{ rec.title }}</h3>
          <p class="mb-0 bo-soft">{{ rec.message }}</p>
        </div>
      </div>
    </div>
    {% else %}
    <div class="list-group-item bo-soft">No recommendations right now.</div>
    {% endfor %}
  </div>
{% endcall %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(() => {
  const root = document.getElementById('analytics-root');
  if (!root) { return; }

  const endpoint = root.dataset.endpoint;
  const STORAGE_KEY = 'analytics.days';
  const charts = { daily: null, weekly: null, monthly: null };
  const summaryNodes = root.querySelectorAll('[data-summary]');
  const categoryList = root.querySelector('#categoryList');
  const recommendationsList = root.querySelector('#recommendationsList');
  const ltvTable = root.querySelector('#ltvTable');
  const heatmapGrid = root.querySelector('#heatmapGrid');
  const daysSelect = root.querySelector('[data-analytics-window]');
  const entityMap = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
  const escapeHtml = (value = '') => String(value ?? '').replace(/[&<>"']/g, char => entityMap[char]);

  function setLoading(active) {
    root.querySelectorAll('[data-loading]').forEach((node) => {
      node.setAttribute('data-loading', active ? 'true' : 'false');
    });
  }

  function animateValue(el, target, { prefix = '', suffix = '', decimals = 2 } = {}) {
    if (!el) return;
    const end = Number(target);
    if (!Number.isFinite(end)) {
      el.textContent = `${prefix}${target}${suffix}`;
      return;
    }
    const current = Number(el.dataset.currentValue ?? el.textContent.replace(/[^0-9.-]/g, '')) || 0;
    const duration = 500;
    const startTime = performance.now();

    function frame(now) {
      const progress = Math.min(1, (now - startTime) / duration);
      const value = current + (end - current) * progress;
      el.textContent = `${prefix}${value.toLocaleString('en-IN', { minimumFractionDigits: decimals, maximumFractionDigits: decimals })}${suffix}`;
      if (progress < 1) {
        requestAnimationFrame(frame);
      } else {
        el.dataset.currentValue = end;
      }
    }
    requestAnimationFrame(frame);
  }

  function renderSummary(summary = {}) {
    summaryNodes.forEach((node) => {
      const key = node.dataset.summary;
      const value = summary[key] ?? 0;
      const prefix = node.dataset.prefix || '';
      const suffix = node.dataset.suffix || '';
      const decimals = Number(node.dataset.dp ?? 2);
      const valueNode = node.querySelector('[data-stat-value]');
      animateValue(valueNode, value, { prefix, suffix, decimals });
    });
  }

  function extractSeries(data = []) {
    return {
      labels: data.map((row) => row.label),
      revenue: data.map((row) => row.revenue),
      expenses: data.map((row) => row.expenses),
      profit: data.map((row) => row.profit),
    };
  }

  function buildLineChart(ctx, data) {
    if (!ctx || !window.Chart) { return null; }
    const series = extractSeries(data);
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: series.labels,
        datasets: [
          { label: 'Revenue', data: series.revenue, borderColor: '#62b5ff', backgroundColor: 'rgba(98,181,255,.15)', tension: .35, fill: true },
          { label: 'Expenses', data: series.expenses, borderColor: '#ffb74d', backgroundColor: 'rgba(255,183,77,.12)', tension: .35, fill: true },
          { label: 'Profit', data: series.profit, borderColor: '#7cf29c', backgroundColor: 'rgba(124,242,156,.12)', tension: .35, fill: true },
        ],
      },
      options: {
        responsive: true,
        animation: {
          duration: 700,
          easing: 'easeOutQuart',
          delay(context) {
            if (!context || typeof context.dataIndex !== 'number') {
              return 0;
            }
            return context.dataIndex * 40;
          },
        },
        plugins: { legend: { labels: { color: '#e9f0ff' } } },
        interaction: { intersect: false, mode: 'index' },
        scales: {
          x: { ticks: { color: '#c9d3ea' }, grid: { color: 'rgba(255,255,255,.05)' } },
          y: { ticks: { color: '#c9d3ea' }, grid: { color: 'rgba(255,255,255,.05)' } },
        },
      },
    });
  }

  function updateLineChart(chart, data) {
    if (!chart) { return; }
    const series = extractSeries(data);
    chart.data.labels = series.labels;
    chart.data.datasets[0].data = series.revenue;
    chart.data.datasets[1].data = series.expenses;
    chart.data.datasets[2].data = series.profit;
    chart.update('active');
  }

  function updateCharts(data) {
    const dailyCtx = document.getElementById('dailyChart');
    const weeklyCtx = document.getElementById('weeklyChart');
    const monthlyCtx = document.getElementById('monthlyChart');

    charts.daily = charts.daily || buildLineChart(dailyCtx, data.daily);
    charts.weekly = charts.weekly || buildLineChart(weeklyCtx, data.weekly);
    charts.monthly = charts.monthly || buildLineChart(monthlyCtx, data.monthly);

    updateLineChart(charts.daily, data.daily);
    updateLineChart(charts.weekly, data.weekly);
    updateLineChart(charts.monthly, data.monthly);
  }

  function renderHeatmap(heatmap) {
    if (!heatmapGrid || !heatmap) { return; }
    heatmapGrid.innerHTML = '';
    const max = heatmap.max || 1;
    const formatter = new Intl.NumberFormat('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

    const headerCell = document.createElement('div');
    headerCell.className = 'heatmap-cell';
    headerCell.textContent = '';
    heatmapGrid.appendChild(headerCell);
    (heatmap.hours || []).forEach((hour) => {
      const cell = document.createElement('div');
      cell.className = 'heatmap-cell';
      cell.textContent = hour;
      heatmapGrid.appendChild(cell);
    });

    (heatmap.days || []).forEach((dayLabel, rowIdx) => {
      const labelCell = document.createElement('div');
      labelCell.className = 'heatmap-cell';
      labelCell.textContent = dayLabel;
      heatmapGrid.appendChild(labelCell);

      (heatmap.matrix?.[rowIdx] || []).forEach((value) => {
        const intensity = max ? value / max : 0;
        const bg = `rgba(98,181,255, ${0.1 + intensity * 0.6})`;
        const cell = document.createElement('div');
        cell.className = 'heatmap-cell';
        cell.style.background = bg;
        cell.title = formatter.format(value);
        cell.textContent = value > 0 ? formatter.format(value / 1000) + 'k' : '';
        heatmapGrid.appendChild(cell);
      });
    });
  }

  function renderCategories(categories = []) {
    if (!categoryList) { return; }
    if (!categories.length) {
      categoryList.innerHTML = '<div class="list-group-item bo-soft">No expenses recorded in this period.</div>';
      return;
    }
    categoryList.innerHTML = categories.map((cat) => `
      <div class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
        <div class="d-flex align-items-center gap-2">
          <span class="badge" style="background-color: ${escapeHtml(cat.color || '#62b5ff')}; color: #0e1629;">${escapeHtml(cat.name)}</span>
          <span class="bo-soft small">${Number(cat.share || 0).toFixed(1)}% of spend</span>
        </div>
        <div class="flex-grow-1 w-100 w-md-auto">
          <div class="progress" style="height: 6px;">
            <div class="progress-bar" role="progressbar" style="width: ${Number(cat.share || 0)}%; background-color: ${escapeHtml(cat.color || '#62b5ff')};"></div>
          </div>
        </div>
        <div class="fw-semibold">Rs ${Number(cat.amount || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
      </div>
    `).join('');
  }

  function resolveBadge(type) {
    switch ((type || '').toLowerCase()) {
      case 'reorder': return 'bo-badge-warning';
      case 'slow': return 'bo-badge-danger';
      case 'info': return 'bo-badge-light';
      default: return 'bo-badge';
    }
  }

  function renderRecommendations(recommendations = []) {
    if (!recommendationsList) { return; }
    if (!recommendations.length) {
      recommendationsList.innerHTML = '<div class="list-group-item bo-soft">No recommendations right now.</div>';
      return;
    }
    recommendationsList.innerHTML = recommendations.map((rec) => `
      <div class="list-group-item">
        <div class="d-flex justify-content-between align-items-start gap-3">
          <div>
            <span class="badge ${resolveBadge(rec.type)} text-uppercase small">${escapeHtml(rec.type)}</span>
            <h3 class="h6 mt-2 mb-1">${escapeHtml(rec.title)}</h3>
            <p class="mb-0 bo-soft">${escapeHtml(rec.message)}</p>
          </div>
        </div>
      </div>
    `).join('');
  }

  function renderLtv(ltv = []) {
    if (!ltvTable) { return; }
    if (!ltv.length) {
      ltvTable.innerHTML = '<tr><td colspan="4" class="bo-soft">No customer data yet.</td></tr>';
      return;
    }
    ltvTable.innerHTML = ltv.map((row) => `
      <tr>
        <td>${escapeHtml(row.customer)}</td>
        <td>${escapeHtml(row.orders)}</td>
        <td>Rs ${Number(row.total || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
        <td>${escapeHtml(row.last_purchase || 'ï¿½')}</td>
      </tr>
    `).join('');
  }

  function applyAnalytics(data = {}) {
    renderSummary(data.summary || {});
    updateCharts({
      daily: data.daily || [],
      weekly: data.weekly || [],
      monthly: data.monthly || [],
    });
    renderHeatmap(data.heatmap || {});
    renderCategories(data.categories || []);
    renderRecommendations(data.recommendations || []);
    renderLtv(data.ltv || []);
  }

  async function loadAnalytics(days, { persist = true } = {}) {
    if (!endpoint) { return; }
    setLoading(true);
    try {
      const response = await fetch(`${endpoint}?days=${encodeURIComponent(days)}`, {
        headers: { 'Accept': 'application/json' },
      });
      if (!response.ok) {
        throw new Error('Failed to load analytics');
      }
      const payload = await response.json();
      applyAnalytics(payload.analytics || {});
      if (persist) {
        localStorage.setItem(STORAGE_KEY, String(payload.days ?? days));
      }
    } catch (error) {
      console.error(error);
      alert('Unable to refresh analytics. Please try again.');
    } finally {
      setLoading(false);
    }
  }

  let initialAnalytics = {};
  try {
    initialAnalytics = JSON.parse(root.dataset.analytics || '{}');
  } catch (error) {
    console.error('Failed to parse analytics payload', error);
  }

  applyAnalytics(initialAnalytics);
  setLoading(false);

  const stampNode = root.querySelector('[data-print-stamp]');
  const updatePrintStamp = () => {
    if (!stampNode) { return; }
    const now = new Date();
    stampNode.textContent = now.toLocaleString(undefined, {
      dateStyle: 'medium',
      timeStyle: 'short',
    });
  };
  updatePrintStamp();
  window.addEventListener('beforeprint', updatePrintStamp);

  const printButton = root.querySelector('[data-print-analytics]');
  if (printButton) {
    printButton.addEventListener('click', () => {
      updatePrintStamp();
      window.print();
    });
  }

  if (daysSelect) {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved && saved !== daysSelect.value) {
      daysSelect.value = saved;
      loadAnalytics(saved, { persist: false });
    }
    daysSelect.addEventListener('change', (event) => {
      const value = event.target.value;
      localStorage.setItem(STORAGE_KEY, value);
      loadAnalytics(value);
    });
  }
})();
</script>
{% endblock %}

