{% extends "layout.html" %}
{% block title %}Dashboard &middot; Evara{% endblock %}

{% block content %}
<section class="hero-halo" data-animate="fade-up">
  <h1 class="page-title">Make every sale feel effortless</h1>
  <p class="lead">Clear numbers. Calm design. Nightly WhatsApp &amp; email reports on autopilot.</p>
  <div class="action-row" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:24px;">
    <a href="{{ url_for('sales.index') }}" class="btn btn-primary">Start quick sale</a>
    <a href="{{ url_for('reports.zreport_view') }}" class="btn btn-ghost">All activity</a>
  </div>
</section>

<section class="grid grid-cols-1 grid-cols-md-3">
  <div class="card stat" data-animate="card">
    <div class="stat-label">Today's revenue</div>
    <div class="stat-value count-up" data-prefix="₹" data-decimals="2" data-value="{{ '%.2f'|format(todays_revenue or 0) }}">₹0</div>
    <span class="muted">Updated seconds ago</span>
  </div>
  <div class="card stat" data-animate="card">
    <div class="stat-label">Today's orders</div>
    <div class="stat-value count-up" data-value="{{ todays_orders or 0 }}">0</div>
    <span class="muted">Across all items</span>
  </div>
  <div class="card stat" data-animate="card">
    <div class="stat-label">Low stock</div>
    <div class="stat-value count-up" data-value="{{ low_stock_count or 0 }}">0</div>
    <span class="muted">Items running low</span>
  </div>
</section>

<section class="grid grid-cols-1 grid-cols-md-2">
  <article class="card" data-animate="card">
    <div class="card-head" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <div>
        <h3 style="margin:0;">Last 7 days</h3>
        <span class="muted">Revenue &middot; Orders</span>
      </div>
      <span class="badge-metric">
        <span class="dot" style="width:6px;height:6px;border-radius:50%;background:#00ffd1;"></span>
        Live sync
      </span>
    </div>
    <canvas id="evChart" height="180"></canvas>
  </article>

  <article class="card" data-animate="card">
    <div class="card-head" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <h3 style="margin:0;">Recent sales</h3>
      <a class="btn btn-ghost btn-sm" href="{{ url_for('sales.history') }}">View all</a>
    </div>
    <ul class="ev-list" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:14px;">
      {% for s in sales[:8] if sales %}
        <li class="recent-sale">
          <span class="item" style="font-weight:600;">{{ s[2] }}</span>
          <span class="meta" style="color:var(--muted);">x{{ s[3] }}</span>
          <span class="amt" style="font-weight:600;color:#00ffd1;">&#8377;{{ '%.2f'|format(s[4]) }}</span>
        </li>
      {% else %}
        <li class="muted">No sales yet. Create your first sale.</li>
      {% endfor %}
    </ul>
  </article>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const labels = {{ (last7_labels or [])|tojson }};
  const revenue = {{ (last7_revenue or [])|tojson }};
  const orders  = {{ (last7_orders  or [])|tojson }};

  const ctx = document.getElementById('evChart');
  if (ctx && labels.length) {
    const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 220);
    gradient.addColorStop(0, 'rgba(14,165,255,0.35)');
    gradient.addColorStop(1, 'rgba(14,165,255,0)');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Revenue',
            data: revenue,
            borderColor: '#00ffd1',
            borderWidth: 3,
            fill: true,
            backgroundColor: gradient,
            tension: .35
          },
          {
            label: 'Orders',
            data: orders,
            borderColor: '#0ea5ff',
            borderDash: [6, 6],
            borderWidth: 2,
            pointRadius: 3,
            pointBackgroundColor: '#0ea5ff',
            fill: false,
            tension: .35
          },
        ]
      },
      options: {
        plugins: {
          legend: { labels: { color: '#a9b4c4', boxWidth: 12, usePointStyle: true } },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: (ctx) => {
                const value = ctx.parsed.y || 0;
                const prefix = ctx.dataset.label === 'Revenue' ? '₹' : '';
                return `${ctx.dataset.label}: ${prefix}${value.toLocaleString('en-IN')}`;
              }
            }
          }
        },
        scales: {
          x: { ticks: { color: '#6c7b92' }, grid: { color: 'rgba(255,255,255,0.04)' } },
          y: { ticks: { color: '#6c7b92' }, grid: { color: 'rgba(255,255,255,0.04)' } }
        },
        interaction: { intersect: false, mode: 'nearest' }
      }
    });
  }
</script>
{% endblock %}
