{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<div class="card mb-3">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h2 class="mb-1">Dashboard</h2>
      <div class="text-muted">Today at a glance</div>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('reports.analytics_view') }}" class="btn-ghost">Analytics</a>
      <a href="{{ url_for('reports.zreport_view') }}" class="btn-ghost">Report</a>
    </div>
  </div>
</div>

<div class="kpi-grid mb-3">
  <div class="kpi">
    <div class="label">Today Sales</div>
    <div class="value">{{ today_count or 0 }}</div>
  </div>
  <div class="kpi">
    <div class="label">Today Revenue</div>
    <div class="value">₹{{ today_rev or 0 }}</div>
  </div>
  <div class="kpi">
    <div class="label">Unpaid Credits</div>
    <div class="value">₹{{ unpaid_credits or 0 }}</div>
  </div>
  <div class="kpi">
    <div class="label">Low Stock</div>
    <div class="value">{{ low_stock_count or 0 }}</div>
  </div>
</div>

<div class="card mb-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="mb-0">Today Trend</h5>
    <span class="text-muted small">Revenue vs Expenses</span>
  </div>
  <canvas id="miniLine" height="110"></canvas>
</div>

<div class="card">
  <h5 class="mb-2">Quick Sale</h5>
  <form method="POST" action="{{ url_for('sales.sell') }}" class="row g-2">
    <div class="col-md-4">
      <select name="item_id" class="form-select" required>
        {% for item in items %}
          <option value="{{ item.id }}">{{ item.name }} (₹{{ item.price }}, stock: {{ item.current_stock }})</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <select name="customer_id" class="form-select">
        <option value="">Walk-in</option>
        {% for customer in customers %}
          <option value="{{ customer.id }}">{{ customer.name }}{% if customer.phone %} ({{ customer.phone }}){% endif %}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <input type="number" name="quantity" min="1" class="form-control" placeholder="Qty" required>
    </div>
    <div class="col-md-3">
      <button class="btn-primary w-100">Sell</button>
    </div>
  </form>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  const chartData = {{ tiny_chart or [] | tojson }};
  const ctx = document.getElementById('miniLine');
  if (ctx && window.Chart && chartData.length){
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartData.map(r => r.t),
        datasets: [
          { label: 'Revenue', data: chartData.map(r => r.rev), borderColor: 'var(--ch-rev)', backgroundColor: 'rgba(0,212,179,.15)', tension: .35, fill: true },
          { label: 'Expenses', data: chartData.map(r => r.exp), borderColor: 'var(--ch-exp)', backgroundColor: 'rgba(255,183,77,.12)', tension: .35, fill: true }
        ]
      },
      options: {
        plugins: { legend: { labels: { color: '#e9f0ff' } } },
        scales: {
          x: { ticks: { color: '#c9d3ea' }, grid: { color: 'rgba(255,255,255,.06)' } },
          y: { ticks: { color: '#c9d3ea' }, grid: { color: 'rgba(255,255,255,.06)' } }
        }
      }
    });
  }
</script>
{% endblock %}
