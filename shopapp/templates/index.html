{% extends "layout.html" %}
{% block title %}Dashboard · ShopApp{% endblock %}

{% block content %}
<section class="hero fade-in">
  <h1>Run your store with clarity.</h1>
  <p>Clean insights, quick actions, and a calm workspace you'll actually enjoy using.</p>
</section>

<div class="grid">
  <!-- KPIs -->
  <div class="card fade-in">
    <h2>Revenue today</h2>
    <div style="font-size:42px;font-weight:800;letter-spacing:-.02em;">₹{{ (today_rev or 0)|int }}</div>
    <small>Compared to yesterday, keep it steady.</small>
  </div>
  <div class="card fade-in">
    <h2>Sales count</h2>
    <div style="font-size:42px;font-weight:800;letter-spacing:-.02em;">{{ (today_count or 0)|int }}</div>
    <small>Fast logging via Quick Sale.</small>
  </div>
  <div class="card fade-in">
    <h2>Unpaid credits</h2>
    <div style="font-size:42px;font-weight:800;letter-spacing:-.02em;">₹{{ (unpaid_credits or 0)|int }}</div>
    <small>Send reminders from Credits.</small>
  </div>
  <div class="card fade-in">
    <h2>Low stock</h2>
    <div style="font-size:42px;font-weight:800;letter-spacing:-.02em;">{{ (low_stock_count or 0)|int }}</div>
    <small>Reorder before it's gone.</small>
  </div>

  <!-- Chart -->
  <div class="card fade-in" style="grid-column: span 2;">
    <h2>Last 7 days</h2>
    <canvas id="chart7" height="160"></canvas>
  </div>

  <!-- Quick sale -->
  <div class="card fade-in">
    <h2>Quick Sale</h2>
    <form method="POST" action="/sell" style="display:grid;gap:12px;margin-top:8px">
      <div>
        <label>Item</label>
        <select class="select" name="item_id" required>
          {% for i in items %}<option value="{{ i[0] }}">{{ i[1] }} (₹{{ i[2] }}, {{ i[3] }} left)</option>{% endfor %}
        </select>
      </div>
      <div>
        <label>Customer</label>
        <select class="select" name="customer_id">
          <option value="">Walk-in</option>
          {% for c in customers %}<option value="{{ c[0] }}">{{ c[1] }} ({{ c[2] }})</option>{% endfor %}
        </select>
      </div>
      <div>
        <label>Quantity</label>
        <input class="input" type="number" name="quantity" min="1" value="1" required>
      </div>
      <button class="btn">Add sale</button>
    </form>
  </div>

  <!-- Add stock -->
  <div class="card fade-in">
    <h2>Add Stock</h2>
    <form method="POST" action="{{ url_for('sales.restock') }}" style="display:grid;gap:12px;margin-top:8px">
      <div>
        <label>Item</label>
        <select class="select" name="item_id" required>
          {% for i in items %}<option value="{{ i[0] }}">{{ i[1] }} ({{ i[3] }} in stock)</option>{% endfor %}
        </select>
      </div>
      <div>
        <label>Quantity to add</label>
        <input class="input" type="number" name="quantity" min="1" value="1" required>
      </div>
      <button class="btn ghost">Add stock</button>
    </form>
  </div>

  <!-- Recent sales -->
  <div class="card fade-in" style="grid-column: span 2;">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
      <h2>Recent sales</h2>
      <a class="btn ghost" href="/sales">Open Sales</a>
    </div>
    <div class="table-wrap" style="overflow:auto;margin-top:10px">
      <table class="table">
        <thead><tr><th>#</th><th>Date</th><th>Item</th><th>Qty</th><th>Total</th><th>Customer</th></tr></thead>
        <tbody>
        {% for s in sales %}
          <tr><td>{{ s[0] }}</td><td>{{ s[1] }}</td><td>{{ s[2] }}</td><td>{{ s[3] }}</td><td>₹{{ '%.0f'|format(s[4]) }}</td><td>{{ s[5] or 'Walk-in' }}</td></tr>
        {% else %}
          <tr><td colspan="6"><small>No sales yet - try Quick Sale.</small></td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
const d={{ chart_data or [] | tojson }}, ctx=document.getElementById('chart7');
if(ctx&&d.length){
  new Chart(ctx,{type:'line',data:{labels:d.map(r=>r.t),datasets:[
    {label:'Revenue',data:d.map(r=>r.rev),borderColor:'#0071e3',backgroundColor:'rgba(0,113,227,.15)',tension:.35,fill:true},
    {label:'Expenses',data:d.map(r=>r.exp||0),borderColor:'#8e8e93',backgroundColor:'rgba(142,142,147,.15)',tension:.35,fill:true}
  ]},options:{plugins:{legend:{labels:{color:'#333'}}},scales:{x:{grid:{color:'rgba(0,0,0,.06)'}},y:{grid:{color:'rgba(0,0,0,.06)'}}}}});
}

// smooth on-scroll reveal (apple-like)
const obs = new IntersectionObserver(es=>es.forEach(e=>{
  if(e.isIntersecting){ e.target.classList.add('fade-in'); obs.unobserve(e.target); }
}),{threshold:.12});
document.querySelectorAll('.card, .hero').forEach(el=>obs.observe(el));
</script>
{% endblock %}
