{% extends "layout.html" %}
{% block title %}Dashboard &middot; ShopApp{% endblock %}

{% block content %}
<div class="dashboard-shell">
  <header class="dash-hero">
    <div class="dash-hero-copy">
      <span class="dash-kicker">Today</span>
      <h1>Make every sale feel effortless.</h1>
      <p>Track progress, rally your team, and keep shelves stocked without the mental load.</p>
    </div>
  </header>

  <div class="dash-topbar" data-sticky>
    <button class="topbar-menu" type="button" data-nav-toggle aria-label="Toggle navigation" aria-expanded="false">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <form class="topbar-search" role="search" action="{{ url_for('sales.history') }}" method="get">
      <label class="visually-hidden" for="globalSearch">Search</label>
      <input id="globalSearch" name="q" type="search" placeholder="Search sales, items, customers..." aria-label="Search ShopApp">
    </form>
    <div class="topbar-actions">
      <a class="btn ghost" href="{{ url_for('sales.history') }}">All activity</a>
      <a class="btn" href="{{ url_for('sales.index') }}?celebrate=1">Start quick sale</a>
    </div>
  </div>

  <section class="dash-section">
    <div class="section-heading">
      <h2>Today at a glance</h2>
    </div>
    <div class="metric-grid">
      <article class="card metric-card">
        <h3>Revenue today</h3>
        <div class="metric-value" data-count="{{ (today_rev or 0)|round(0, 'floor')|int }}" data-format="money">&#8377;0</div>
        <p>Compared to yesterday, keep it steady.</p>
      </article>
      <article class="card metric-card">
        <h3>Sales count</h3>
        <div class="metric-value" data-count="{{ (today_count or 0)|int }}">0</div>
        <p>Log each sale in seconds with Quick Sale.</p>
      </article>
      <article class="card metric-card">
        <h3>Unpaid credits</h3>
        <div class="metric-value" data-count="{{ (unpaid_credits or 0)|round(0, 'floor')|int }}" data-format="money">&#8377;0</div>
        <p>Send gentle nudges from Credits to close dues.</p>
      </article>
      <article class="card metric-card">
        <h3>Low stock</h3>
        <div class="metric-value" data-count="{{ (low_stock_count or 0)|int }}">0</div>
        <p>Reorder before essentials run out.</p>
      </article>
    </div>
  </section>

  <section class="dash-section">
    <div class="section-heading">
      <h2>Performance pulse</h2>
    </div>
    <div class="card chart-card">
      <div class="chart-meta">
        <span class="chart-caption">Revenue vs expenses &middot; last 7 days</span>
        <div class="micro-spinner" aria-hidden="true"></div>
      </div>
      <canvas id="chart7" height="180"></canvas>
    </div>
  </section>

  <section class="dash-section">
    <div class="section-heading">
      <h2>Quick actions</h2>
    </div>
    <div class="action-grid">
      <article class="card action-card">
        <h3>Quick sale</h3>
        <form method="post" action="/sell" class="action-form">
          <label for="quick_item">Item</label>
          <select id="quick_item" name="item_id" required>
            {% for i in items %}
              <option value="{{ i[0] }}">{{ i[1] }} (&#8377;{{ '%.0f'|format(i[2]) }}, {{ i[3] }} left)</option>
            {% endfor %}
          </select>

          <label for="quick_customer">Customer</label>
          <select id="quick_customer" name="customer_id">
            <option value="">Walk-in</option>
            {% for c in customers %}
              <option value="{{ c[0] }}">{{ c[1] }} ({{ c[2] }})</option>
            {% endfor %}
          </select>

          <label for="quick_quantity">Quantity</label>
          <input id="quick_quantity" type="number" name="quantity" min="1" value="1" required>

          <button class="btn" type="submit">Add sale</button>
        </form>
      </article>

      <article class="card action-card">
        <h3>Add stock</h3>
        <form method="post" action="{{ url_for('sales.restock') }}" class="action-form">
          <label for="restock_item">Item</label>
          <select id="restock_item" name="item_id" required>
            {% for i in items %}
              <option value="{{ i[0] }}">{{ i[1] }} ({{ i[3] }} in stock)</option>
            {% endfor %}
          </select>

          <label for="restock_quantity">Quantity to add</label>
          <input id="restock_quantity" type="number" name="quantity" min="1" value="1" required>

          <button class="btn ghost" type="submit">Add stock</button>
        </form>
      </article>
    </div>
  </section>

  <section class="dash-section">
    <div class="section-heading">
      <h2>Recent sales</h2>
    </div>
    <div class="card table-card">
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Item</th>
              <th>Qty</th>
              <th>Total</th>
              <th>Customer</th>
            </tr>
          </thead>
          <tbody>
            {% for s in sales %}
              <tr>
                <td>{{ s[0] }}</td>
                <td>{{ s[1] }}</td>
                <td>{{ s[2] }}</td>
                <td>{{ s[3] }}</td>
                <td>&#8377;{{ '%.0f'|format(s[4]) }}</td>
                <td>{{ s[5] or 'Walk-in' }}</td>
              </tr>
            {% else %}
              <tr>
                <td colspan="6"><small>No sales yet &mdash; try Quick Sale to get started.</small></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  const chartData = {{ chart_data or [] | tojson }};
  const chartCanvas = document.getElementById('chart7');
  if (chartCanvas && chartData.length) {
    new Chart(chartCanvas, {
      type: 'line',
      data: {
        labels: chartData.map(point => point.t),
        datasets: [
          {
            label: 'Revenue',
            data: chartData.map(point => point.rev),
            borderColor: '#0071E3',
            backgroundColor: 'rgba(0, 113, 227, 0.12)',
            fill: true,
            tension: 0.35
          },
          {
            label: 'Expenses',
            data: chartData.map(point => point.exp || 0),
            borderColor: '#A5B4FC',
            backgroundColor: 'rgba(165, 180, 252, 0.12)',
            fill: true,
            tension: 0.35
          }
        ]
      },
      options: {
        plugins: {
          legend: {
            labels: {
              color: '#1f2937',
              font: { family: 'Inter, "SF Pro Display", -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif' }
            }
          }
        },
        scales: {
          x: {
            grid: { color: 'rgba(15, 23, 42, 0.05)' },
            ticks: { color: 'rgba(15, 23, 42, 0.55)' }
          },
          y: {
            grid: { color: 'rgba(15, 23, 42, 0.05)' },
            ticks: { color: 'rgba(15, 23, 42, 0.55)' }
          }
        }
      }
    });
  }
</script>
{% endblock %}
