{% extends "layout.html" %}
{% block title %}Dashboard · Evara{% endblock %}

{% block content %}
<section class="ev-hero">
  <div class="ev-hero__left">
    <h1>Run your world with <span class="ink">Evara</span></h1>
    <p class="subtitle">Sales, credits, inventory & insights — beautifully simple.</p>
    <div class="cta-row">
      <a href="{{ url_for('add_item') }}" class="ev-btn ev-btn--primary">Start quick sale</a>
      <a href="{{ url_for('reports.analytics') }}" class="ev-btn ev-btn--soft">View analytics</a>
    </div>
  </div>
  <div class="ev-hero__right">
    <div class="ev-kpi">
      <div class="ev-kpi__label">Today’s revenue</div>
      <div class="ev-kpi__value">₹{{ '%.2f'|format(todays_revenue or 0) }}</div>
      <div class="ev-kpi__spark" id="spark1"></div>
    </div>
    <div class="ev-kpi">
      <div class="ev-kpi__label">Outstanding credit</div>
      <div class="ev-kpi__value">₹{{ '%.2f'|format(outstanding_credit or 0) }}</div>
      <div class="ev-kpi__spark" id="spark2"></div>
    </div>
  </div>
</section>

<section class="grid-3">
  <article class="ev-card">
    <h3 class="ev-card__title">Sales</h3>
    <p class="muted">Last 7 days</p>
    <canvas id="salesChart" height="120"></canvas>
  </article>
  <article class="ev-card">
    <h3 class="ev-card__title">Expenses</h3>
    <p class="muted">This month</p>
    <canvas id="expenseChart" height="120"></canvas>
  </article>
  <article class="ev-card">
    <h3 class="ev-card__title">Low stock</h3>
    <ul class="ev-list">
      {% for name, stock in (low_stock or [])[:6] %}
        <li><span>{{ name }}</span><span class="badge badge--warn">{{ stock }}</span></li>
      {% else %}
        <li class="muted">All good ✅</li>
      {% endfor %}
    </ul>
  </article>
</section>

<section class="ev-slab">
  <h3 class="ev-slab__title">Recent activity</h3>
  <table class="ev-table">
    <thead><tr><th>Date</th><th>Item</th><th>Qty</th><th>Total</th></tr></thead>
    <tbody>
      {% for s in (sales or [])[:8] %}
        <tr>
          <td>{{ s[1] }}</td>
          <td>{{ s[2] }}</td>
          <td>{{ s[3] }}</td>
          <td>₹{{ '%.2f'|format(s[4]) }}</td>
        </tr>
      {% else %}
        <tr><td colspan="4" class="muted">No sales yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // Simple sparkline + charts (vanilla) — replace with Chart.js later if you want.
  const lerp = (a,b,t)=>a+(b-a)*t;

  function spark(id, points=32){
    const el = document.getElementById(id);
    if(!el) return;
    const max = 40; const h = 36; const path = [];
    for (let i=0;i<points;i++){
      const y = Math.sin(i*.45)+Math.cos(i*.23)*.6 + Math.random()*.5;
      path.push(Math.round(lerp(h*1.2, h*.2, (y+2)/4)));
    }
    el.innerHTML = `<svg viewBox="0 0 ${points*6} ${h}" preserveAspectRatio="none">
      <polyline fill="none" stroke="var(--ev-mint-600)" stroke-width="2"
        points="${path.map((y,i)=>`${i*6},${y}`).join(' ')}" />
    </svg>`;
  }
  spark('spark1'); spark('spark2');

  function miniBar(canvasId){
    const c = document.getElementById(canvasId);
    if(!c) return;
    const ctx = c.getContext('2d');
    const w = c.width = c.offsetWidth; const h = c.height = c.offsetHeight;
    const bars = 20; const bw = (w/(bars*1.5));
    ctx.clearRect(0,0,w,h);
    for(let i=0;i<bars;i++){
      const val = 0.2 + Math.random()*0.75;
      const barH = val*h;
      const x = i*(bw*1.5);
      const y = h - barH;
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--ev-mint-500');
      ctx.fillRect(x, y, bw, barH);
    }
  }
  miniBar('salesChart'); miniBar('expenseChart');
</script>
{% endblock %}
