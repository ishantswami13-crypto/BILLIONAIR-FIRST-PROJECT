{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
  <!-- Hero -->
  <section class="card fadeUp" style="animation-delay:.12s">
    <h1 style="font-size:var(--f-2xl);font-weight:800;letter-spacing:-.02em;
      background:linear-gradient(90deg,#fff,var(--accent-mint));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;">
      Today Overview
    </h1>
    <p style="color:var(--ink-dim);margin-top:6px;">Your store at a glance.</p>
  </section>

  <!-- KPIs -->
  <section class="grid-4">
    <div class="card fadeUp" style="animation-delay:.16s">
      <div style="color:var(--ink-soft);font-size:var(--f-sm);text-transform:uppercase;letter-spacing:.04em;">Revenue</div>
      <div style="font-size:var(--f-2xl);font-weight:800; margin-top:4px;">₹{{ today_rev or 0 }}</div>
    </div>
    <div class="card fadeUp" style="animation-delay:.18s">
      <div style="color:var(--ink-soft);font-size:var(--f-sm);text-transform:uppercase;letter-spacing:.04em;">Sales</div>
      <div style="font-size:var(--f-2xl);font-weight:800; margin-top:4px;">{{ today_count or 0 }}</div>
    </div>
    <div class="card fadeUp" style="animation-delay:.20s">
      <div style="color:var(--ink-soft);font-size:var(--f-sm);text-transform:uppercase;letter-spacing:.04em;">Unpaid Credits</div>
      <div style="font-size:var(--f-2xl);font-weight:800; margin-top:4px;">₹{{ unpaid_credits or 0 }}</div>
    </div>
    <div class="card fadeUp" style="animation-delay:.22s">
      <div style="color:var(--ink-soft);font-size:var(--f-sm);text-transform:uppercase;letter-spacing:.04em;">Low Stock</div>
      <div style="font-size:var(--f-2xl);font-weight:800; margin-top:4px;">{{ low_stock_count or 0 }}</div>
    </div>
  </section>

  <!-- Chart + Quick actions -->
  <section class="grid-2-1">
    <div class="card fadeUp" style="animation-delay:.24s">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <h3 style="font-size:var(--f-lg);font-weight:700;">7-Day Performance</h3>
        <a href="/analytics" class="btn">Open Analytics</a>
      </div>
      <canvas id="chart7" height="150"></canvas>
    </div>

    <div class="card fadeUp" style="animation-delay:.28s">
      <h3 style="font-size:var(--f-lg);font-weight:700;margin-bottom:8px;">Quick Sale</h3>
      <form method="POST" action="/sell">
        <label>Item</label>
        <select name="item_id" required>
          {% for i in items %}
            <option value="{{ i[0] }}">{{ i[1] }} (₹{{ i[2] }}, {{ i[3] }} left)</option>
          {% endfor %}
        </select>
        <label>Customer</label>
        <select name="customer_id">
          <option value="">Walk-in</option>
          {% for c in customers %}
            <option value="{{ c[0] }}">{{ c[1] }} ({{ c[2] }})</option>
          {% endfor %}
        </select>
        <label>Quantity</label>
        <input type="number" name="quantity" min="1" required>
        <button class="btn primary" style="width:100%;margin-top:10px;" onclick="launchConfetti()">Sell</button>
      </form>

      <div class="hr"></div>
      <button class="btn" style="width:100%;margin-bottom:8px;" onclick="openSheet('addItemSheet')">+ Add Item</button>
      <button class="btn" style="width:100%;margin-bottom:8px;" onclick="openSheet('addCustomerSheet')">+ Add Customer</button>
      <button class="btn" style="width:100%;" onclick="openSheet('addExpenseSheet')">+ Add Expense</button>
    </div>
  </section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  const d = {{ chart_data or [] | tojson }};
  const ctx = document.getElementById('chart7');
  if (ctx && d.length){
    new Chart(ctx,{
      type:'line',
      data:{
        labels:d.map(r=>r.t),
        datasets:[
          {label:'Revenue', data:d.map(r=>r.rev), borderColor:'#82ffc3', backgroundColor:'rgba(130,255,195,.16)', tension:.35, fill:true},
          {label:'Expenses', data:d.map(r=>r.exp), borderColor:'#0a84ff', backgroundColor:'rgba(10,132,255,.12)', tension:.35, fill:true}
        ]
      },
      options:{
        plugins:{legend:{labels:{color:'#fff'}}},
        scales:{
          x:{ticks:{color:'rgba(255,255,255,.75)'}, grid:{color:'rgba(255,255,255,.10)'}},
          y:{ticks:{color:'rgba(255,255,255,.75)'}, grid:{color:'rgba(255,255,255,.10)'}}
        }
      }
    });
  }
</script>
{% endblock %}
