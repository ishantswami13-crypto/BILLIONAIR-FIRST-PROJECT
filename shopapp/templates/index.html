{% extends 'layout.html' %}

{% block content %}
<div class="card-glass p-4 mb-4 text-white" style="border-radius: 24px;">
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-end gap-4">
    <div>
      <p class="text-uppercase fw-semibold mb-1" style="letter-spacing: 0.3em; color: #8fd6ff;">Today at a glance</p>
      <h1 class="display-6 mb-2">Welcome back{% if session.get('user') %}, {{ session['user'] }}{% endif %}</h1>
      <p class="mb-0 soft-text">Track sales momentum, cashflow split, low stock, and outstanding udhar without leaving this screen.</p>
    </div>
    <div class="row g-3 flex-grow-1">
      <div class="col-6 col-lg-3">
        <div class="card card-body text-white shadow-sm stat-card">
          <span class="text-uppercase small soft-text">Revenue today</span>
          <span class="fs-4 fw-semibold">Rs {{ '%.2f'|format(today_rev) }}</span>
        </div>
      </div>
      <div class="col-6 col-lg-3">
        <div class="card card-body text-white shadow-sm stat-card">
          <span class="text-uppercase small soft-text">Transactions</span>
          <span class="fs-4 fw-semibold">{{ today_count }}</span>
        </div>
      </div>
      <div class="col-6 col-lg-3">
        <div class="card card-body text-white shadow-sm stat-card">
          <span class="text-uppercase small soft-text">Discounts</span>
          <span class="fs-5 fw-semibold">Rs {{ '%.2f'|format(today_discount) }}</span>
        </div>
      </div>
      <div class="col-6 col-lg-3">
        <div class="card card-body text-white shadow-sm stat-card">
          <span class="text-uppercase small soft-text">GST collected</span>
          <span class="fs-5 fw-semibold">Rs {{ '%.2f'|format(today_tax) }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

{% if invoice_ready %}
<div class="alert alert-success card-glass">
  Invoice for sale #{{ invoice_ready }} is ready.
  <a class="ms-2" href="{{ url_for('sales.invoice', sale_id=invoice_ready) }}">Download now</a>
</div>
{% endif %}

<div class="row g-3 mb-4">
  <div class="col-12 col-md-6 col-xl-3">
    <a class="card-glass dashboard-link" href="{{ url_for('reports.zreport_view') }}">
      <div>
        <h3>Performance reports</h3>
        <p class="mb-0">Download daily Z-reports and revenue breakdowns.</p>
      </div>
      <span class="dashboard-link__arrow">→</span>
    </a>
  </div>
  <div class="col-12 col-md-6 col-xl-3">
    <a class="card-glass dashboard-link" href="{{ url_for('inventory.items') }}">
      <div>
        <h3>Restock &amp; suppliers</h3>
        <p class="mb-0">Manage inventory, prices, and low-stock alerts.</p>
      </div>
      <span class="dashboard-link__arrow">→</span>
    </a>
  </div>
  <div class="col-12 col-md-6 col-xl-3">
    <a class="card-glass dashboard-link" href="{{ url_for('expenses.expenses') }}">
      <div>
        <h3>Expenses</h3>
        <p class="mb-0">Log daily spend to keep margins sharp.</p>
      </div>
      <span class="dashboard-link__arrow">→</span>
    </a>
  </div>
  <div class="col-12 col-md-6 col-xl-3">
    <a class="card-glass dashboard-link" href="{{ url_for('customers.customers') }}">
      <div>
        <h3>Customers &amp; udhar</h3>
        <p class="mb-0">Update contacts, monitor dues, and settle credit.</p>
      </div>
      <span class="dashboard-link__arrow">→</span>
    </a>
  </div>
</div>

<div class="card-glass p-4 mb-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="h5 mb-1">Performance insights</h2>
      <p class="soft-text mb-0">Profit vs. expense trend plus payment mix for the last seven days.</p>
    </div>
    <span class="badge bg-primary bg-opacity-75">Analytics</span>
  </div>
  <div class="row g-4">
    <div class="col-lg-7">
      <div class="card-glass p-3" data-shimmer>
        <canvas id="profitChart" height="220"></canvas>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="card-glass p-3" data-shimmer>
        <canvas id="paymentChart" height="220"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-6">
    <div class="card-glass p-4 h-100 text-white">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 mb-0">Create a quick sale</h2>
        <span class="badge bg-primary bg-opacity-75">POS</span>
      </div>
      <form class="row g-3" method="POST" action="{{ url_for('sales.sell') }}">
        <div class="col-12">
          <label class="form-label">Item</label>
          <select class="form-select" name="item_id" required>
            {% for item in items %}
            <option value="{{ item.id }}">{{ item.name }} (Rs {{ '%.2f'|format(item.price) }}, stock {{ item.current_stock }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Quantity</label>
          <input class="form-control" type="number" min="1" name="quantity" value="1" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Payment method</label>
          <select class="form-select" name="payment_method">
            <option value="cash">Cash</option>
            <option value="upi">UPI</option>
            <option value="card">Card</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Discount (Rs)</label>
          <input class="form-control" type="number" step="0.01" name="discount" value="0">
        </div>
        <div class="col-md-6">
          <label class="form-label">Sale type</label>
          <select class="form-select" name="sale_type">
            <option value="paid">Paid</option>
            <option value="udhar">Udhar (credit)</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Existing customer</label>
          <select class="form-select" name="customer_id">
            <option value="">Walk-in</option>
            {% for customer in customers %}
            <option value="{{ customer.id }}">{{ customer.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12">
          <small class="text-muted">Need invoice or udhar? Add customer details below.</small>
        </div>
        <div class="col-md-6">
          <input class="form-control" type="text" name="customer_name" placeholder="Customer name">
        </div>
        <div class="col-md-6">
          <input class="form-control" type="text" name="customer_phone" placeholder="Phone (optional)">
        </div>
        <div class="col-md-6">
          <input class="form-control" type="email" name="customer_email" placeholder="Email (optional)">
        </div>
        <div class="col-12">
          <textarea class="form-control" name="customer_address" rows="2" placeholder="Billing address"></textarea>
        </div>
        <div class="col-12 text-end">
          <button class="btn btn-primary" type="submit">Complete sale</button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card-glass p-4 mb-4 text-white">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 mb-0">Payment split</h2>
        <span class="badge bg-light text-dark">Today</span>
      </div>
      {% if payment_summary %}
      <ul class="list-unstyled mb-0">
        {% for row in payment_summary %}
        <li class="d-flex justify-content-between py-2 border-bottom border-secondary border-opacity-25">
          <span>{{ row.method|capitalize }}</span>
          <span>Rs {{ '%.2f'|format(row.amount) }}</span>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="soft-text mb-0">No sales recorded yet today.</p>
      {% endif %}
    </div>

    <div id="low-stock" class="card-glass p-4 text-white">
      <h2 class="h5 mb-3">Low stock &amp; udhar</h2>
      <div class="d-flex justify-content-between flex-wrap gap-2 mb-3">
        <span class="badge bg-warning text-dark">Low stock: {{ low_stock|length }}</span>
        <span class="badge bg-danger bg-opacity-75">Outstanding udhar: Rs {{ '%.2f'|format(outstanding_udhar) }}</span>
      </div>
      {% if low_stock %}
      <ul class="list-unstyled mb-0">
        {% for item in low_stock %}
        <li class="d-flex justify-content-between py-2 border-bottom border-secondary border-opacity-25">
          <div>
            <strong>{{ item.name }}</strong>
            {% if item.reorder_level %}
            <span class="d-block text-muted small">Reorder at {{ item.reorder_level }}</span>
            {% endif %}
          </div>
          <span>{{ item.current_stock }} left</span>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="soft-text mb-0">All inventory looks healthy. Keep the shelves stocked!</p>
      {% endif %}
    </div>
  </div>
</div>

<div class="card-glass p-4 mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="h5 mb-1 text-white">Recent sales</h2>
      <p class="mb-0 soft-text">Latest transactions with quick access to customers and invoices.</p>
    </div>
    <a class="btn btn-outline-light btn-sm" href="{{ url_for('reports.zreport_view') }}">Download report</a>
  </div>
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle mb-0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Date</th>
          <th>Item</th>
          <th>Qty</th>
          <th>Total (Rs)</th>
          <th>Customer</th>
          <th>Invoice</th>
        </tr>
      </thead>
      <tbody>
        {% for sale in sales %}
        <tr>
          <td>{{ sale.id }}</td>
          <td>{{ sale.date.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>{{ sale.item }}</td>
          <td>{{ sale.quantity }}</td>
          <td>{{ '%.2f'|format(sale.net_total) }}</td>
          <td>{{ sale.customer.name if sale.customer else 'Walk-in' }}</td>
          <td>
            <a href="{{ url_for('sales.invoice', sale_id=sale.id) }}" class="btn btn-sm btn-outline-light">Download</a>
            <a href="{{ url_for('sales.send_invoice_route', sale_id=sale.id) }}" class="btn btn-sm btn-outline-light ms-1">Email</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Inline styles for this page -->
<style>
  .stat-card {
    background: rgba(35, 45, 84, 0.85);
    border-radius: 18px;
    border: 1px solid rgba(255, 255, 255, 0.08);
  }
  .dashboard-link {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    text-decoration: none;
    color: #f7f9ff;
    border-radius: 20px;
    transition: transform 0.2s ease, border 0.2s ease;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
  .dashboard-link:hover {
    transform: translateY(-4px);
    border-color: rgba(98, 181, 255, 0.6);
  }
  .dashboard-link h3 { margin-bottom: 0.25rem; font-size: 1.1rem; }
  .dashboard-link__arrow { font-size: 1.5rem; opacity: 0.6; }
  .soft-text { color: rgba(255,255,255,0.75); }
</style>

<!-- Chart.js page script -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const profitCanvas = document.getElementById('profitChart');
    const paymentsCanvas = document.getElementById('paymentChart');

    const labels = {{ chart_labels|tojson }};
    const salesData = {{ chart_sales|tojson }};
    const expenseData = {{ chart_expenses|tojson }};
    const profitData = {{ chart_profit|tojson }};
    const paymentChart = {{ payment_chart|tojson }};

    if (profitCanvas && window.Chart) {
      new Chart(profitCanvas, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Profit', data: profitData, borderColor: '#62b5ff', backgroundColor: 'rgba(98,181,255,0.2)', tension: 0.35, fill: true },
            { label: 'Revenue', data: salesData, borderColor: '#7cf29c', backgroundColor: 'rgba(124,242,156,0.15)', tension: 0.35, fill: true },
            { label: 'Expenses', data: expenseData, borderColor: '#ffb74d', backgroundColor: 'rgba(255,183,77,0.15)', tension: 0.35, fill: true }
          ]
        },
        options: {
          plugins: { legend: { labels: { color: '#f7f9ff' } } },
          scales: {
            x: { ticks: { color: '#f7f9ff' }, grid: { color: 'rgba(255,255,255,0.08)' } },
            y: { ticks: { color: '#f7f9ff' }, grid: { color: 'rgba(255,255,255,0.08)' } }
          }
        }
      });
    }

    if (paymentsCanvas && window.Chart) {
      new Chart(paymentsCanvas, {
        type: 'doughnut',
        data: {
          labels: paymentChart.labels,
          datasets: [{ data: paymentChart.amounts, backgroundColor: ['#62b5ff','#7cf29c','#ffb74d','#e57373','#ba68c8'], borderWidth: 0 }]
        },
        options: { plugins: { legend: { position: 'bottom', labels: { color: '#f7f9ff' } } } }
      });
    }
  });
</script>
{% endblock %}
