{% extends "layout.html" %}
{% block title %}Sale {{ sale.invoice_number or sale.id }} · ShopApp{% endblock %}

{% block content %}
<section class="hero fade-in" style="padding:70px 10% 30px">
  <h1>Invoice {{ sale.invoice_number or sale.id }}</h1>
  <p>Recorded on {{ sale.date.strftime('%d %b %Y, %I:%M %p') if sale.date else 'Unknown date' }}.</p>
</section>

<div class="grid">
  <div class="card fade-in">
    <h2>Sale overview</h2>
    <dl style="display:grid;grid-template-columns:140px 1fr;gap:6px 18px;margin-top:16px">
      <dt>Amount</dt><dd><strong>₹{{ '%.2f'|format(sale.net_total or sale.total or 0) }}</strong></dd>
      <dt>Item</dt><dd>{{ sale.item }}</dd>
      <dt>Quantity</dt><dd>{{ sale.quantity }}</dd>
      <dt>Customer</dt><dd>{{ sale.customer.name if sale.customer else 'Walk-in' }}</dd>
      <dt>Payment</dt><dd>{{ (sale.payment_method or 'cash')|title }}</dd>
      <dt>Location</dt><dd>{{ sale.location.name if sale.location else 'Not set' }}</dd>
    </dl>
    <div style="margin-top:18px;display:flex;gap:12px;flex-wrap:wrap">
      <a class="btn ghost" href="{{ url_for('sales.invoice', sale_id=sale.id) }}">Download invoice PDF</a>
      <a class="btn ghost" href="{{ url_for('sales.history') }}">Back to history</a>
    </div>
  </div>

  <div class="card fade-in">
    <h2>GST compliance</h2>
    <p style="margin-top:10px">
      Status:
      <span style="display:inline-block;padding:4px 10px;border-radius:999px;background:#f0f1f5">
        {{ sale.gst_status|replace('_', ' ')|title }}
      </span>
    </p>
    {% if sale.irn %}
      <p><small>IRN: {{ sale.irn }}</small></p>
    {% endif %}
    {% if sale.eway_bill_no %}
      <p><small>E-way bill: {{ sale.eway_bill_no }}</small></p>
    {% endif %}
    {% if live_status %}
      <details style="margin-top:14px">
        <summary>Latest update</summary>
        <pre style="background:#f8f9fc;border-radius:12px;padding:12px;margin-top:8px">{{ live_status|tojson(indent=2) }}</pre>
      </details>
    {% endif %}
    {% if gst_configured %}
      <form method="post" action="{{ url_for('sales.submit_gst', sale_id=sale.id) }}" style="margin-top:18px">
        <button class="btn" type="submit">Submit e-invoice</button>
      </form>
    {% else %}
      <p style="margin-top:18px"><small>Add GST provider credentials in settings to enable e-invoice submissions.</small></p>
    {% endif %}
  </div>

  <div class="card fade-in">
    <h2>Payments</h2>
    <div style="margin-top:12px;display:grid;gap:12px">
      <form method="post" action="{{ url_for('sales.create_payment_intent_for_sale', sale_id=sale.id) }}" style="display:grid;gap:10px">
        <div>
          <label>Provider</label>
          {% if payment_providers %}
            <select class="select" name="provider">
              {% for provider in payment_providers %}
              <option value="{{ provider.name }}">{{ provider.display_name }}</option>
              {% endfor %}
            </select>
          {% else %}
            <div style="padding:10px;border:1px dashed #e0e3ea;border-radius:8px;background:#f9fafc">
              <small>No providers configured. Add Razorpay or Stripe keys in settings.</small>
            </div>
          {% endif %}
        </div>
        <div>
          <label>Amount</label>
          <input class="input" type="number" name="amount" step="0.01" value="{{ sale.net_total or sale.total or 0 }}">
        </div>
        <div>
          <label>Reference (optional)</label>
          <input class="input" type="text" name="reference" placeholder="Customer ref / note">
        </div>
        <button class="btn" type="submit" {% if not payment_providers %}disabled{% endif %}>Create payment intent</button>
      </form>

      <div class="table-wrap" style="overflow:auto">
        <table class="table">
          <thead>
            <tr><th>ID</th><th>Provider</th><th>Status</th><th>Amount</th><th>Updated</th></tr>
          </thead>
          <tbody>
            {% for intent in payment_intents %}
            <tr>
              <td>{{ intent.id }}</td>
              <td>{{ intent.provider|title }}</td>
              <td>{{ intent.status|replace('_',' ')|title }}</td>
              <td>₹{{ '%.2f'|format(intent.amount) }}</td>
              <td>{{ intent.updated_at.strftime('%d %b %Y %H:%M') if intent.updated_at else '—' }}</td>
            </tr>
            {% else %}
            <tr><td colspan="5"><small>No payment intents yet.</small></td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card fade-in" style="grid-column:1/-1">
    <h2>Submission history</h2>
    <div class="table-wrap" style="overflow:auto;margin-top:12px">
      <table class="table">
        <thead>
          <tr><th>ID</th><th>Status</th><th>Requested</th><th>Submitted</th><th>Acknowledged</th><th>Error</th></tr>
        </thead>
        <tbody>
          {% for record in submissions %}
          <tr>
            <td>{{ record.id }}</td>
            <td>{{ record.status|replace('_',' ')|title }}</td>
            <td>{{ record.created_at.strftime('%d %b %Y %H:%M') if record.created_at else '-' }}</td>
            <td>{{ record.submitted_at.strftime('%d %b %Y %H:%M') if record.submitted_at else '-' }}</td>
            <td>{{ record.acknowledged_at.strftime('%d %b %Y %H:%M') if record.acknowledged_at else '-' }}</td>
            <td>{{ record.error_message or '—' }}</td>
          </tr>
          {% else %}
          <tr><td colspan="6"><small>No submissions yet.</small></td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
